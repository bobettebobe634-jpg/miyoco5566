<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>公司設備管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f9fafb; margin: 0; padding: 0; }
    h1 { text-align: center; margin: 30px 0 10px; }
    p.subtext { text-align: center; color: #666; margin: 0 0 20px; }
    .btn-bar { text-align: center; margin-bottom: 15px; }
    button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 0 4px; }
    button.add { background: #4caf50; color: #fff; }
    button.location { background: #3b82f6; color: #fff; }
    table { width: 90%; max-width: 900px; margin: auto; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
    th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { cursor: pointer; user-select: none; background: #f3f4f6; }
    tr.disabled { color: #999; background: #f9f9f9; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 320px; }
    .modal input { width: 100%; padding: 6px; margin-bottom: 10px; }
    .modal-footer { text-align: right; }
    .badge { background: #3b82f6; color: #fff; padding: 3px 6px; border-radius: 4px; font-size: 12px; }
  </style>
</head>
<body>
  <h1>公司設備管理</h1>
  <p class="subtext">點選任一列可編輯，敏感操作需密碼，但60秒內免重輸入</p>
  <div class="btn-bar">
    <button class="add" id="addDeviceBtn">新增設備</button>
    <button class="location" id="setDefaultLocation">常態位置</button>
  </div>

  <table id="deviceTable">
    <thead>
      <tr>
        <th data-key="name">設備</th>
        <th data-key="location">目前位置</th>
        <th>累計時長</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal for add/edit -->
  <div class="modal" id="deviceModal">
    <div class="modal-content">
      <h3 id="modalTitle">新增設備</h3>
      <input type="text" id="deviceName" placeholder="設備名稱">
      <input type="text" id="deviceLocation" placeholder="目前位置">
      <div id="passwordBlock">
        <input type="password" id="devicePassword" placeholder="請輸入密碼">
      </div>
      <div class="modal-footer">
        <button id="saveBtn">保存</button>
        <button id="deleteBtn" style="background:red;color:white;display:none;">刪除</button>
        <button id="cancelBtn">取消</button>
      </div>
    </div>
  </div>

<script>
const PROXY_URL = "https://my-proxy.miyoco5566.workers.dev";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFXnH7OvrIa70D6fz3c-ExZxXOtnz3bSC-EOoQA4Kko9qx2I8lhsIrKDILFscNQHmmAA/exec";
let devices = [];
let passwordValidatedUntil = 0;
let currentEdit = null;
let sortKey = null;
let sortAsc = true;

async function loadDevices() {
  const res = await fetch(`${PROXY_URL}?target=${SCRIPT_URL}`);
  devices = await res.json();
  renderTable();
}

function renderTable() {
  const tbody = $("#deviceTable tbody");
  tbody.empty();
  devices.forEach(d => {
    const row = $("<tr>").toggleClass("disabled", Date.now() > passwordValidatedUntil);
    row.append($("<td>").text(d["設備"] || d.name));
    let locTd = $("<td>");
    locTd.text(d["目前位置"] || d.location);
    if (d.default) locTd.append($("<span>").addClass("badge").text("常"));
    row.append(locTd);
    row.append($("<td>").text(calcDuration(d.createdAt || d["建立時間"])));
    row.on("click", () => openEdit(d));
    tbody.append(row);
  });
}

function calcDuration(startTime) {
  if (!startTime || startTime === "N/A") return "N/A";
  const start = new Date(startTime);
  if (isNaN(start)) return "N/A";
  let diff = Date.now() - start.getTime();
  let hours = Math.floor(diff / 3600000);
  let minutes = Math.floor(diff / 60000) % 60;
  let seconds = Math.floor(diff / 1000) % 60;
  return `${hours.toString().padStart(2,"0")}:${minutes.toString().padStart(2,"0")}:${seconds.toString().padStart(2,"0")}`;
}

$("#deviceTable th").on("click", function(){
  const key = $(this).data("key");
  if (!key) return;
  sortAsc = sortKey === key ? !sortAsc : true;
  sortKey = key;
  devices.sort((a,b)=>{
    const va = a[key] || a["設備"] || "";
    const vb = b[key] || b["設備"] || "";
    return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
  });
  renderTable();
});

$("#addDeviceBtn").on("click", ()=> openEdit(null));
$("#cancelBtn").on("click", ()=> $("#deviceModal").hide());
$("#saveBtn").on("click", saveDevice);
$("#deleteBtn").on("click", deleteDevice);

function openEdit(data){
  currentEdit = data;
  $("#modalTitle").text(data ? "編輯設備" : "新增設備");
  $("#deviceName").val(data ? (data.設備||data.name) : "");
  $("#deviceLocation").val(data ? (data.目前位置||data.location) : "");
  $("#passwordBlock").toggle(Date.now() > passwordValidatedUntil);
  $("#deleteBtn").toggle(!!data);
  $("#deviceModal").show();
}

async function saveDevice(){
  const name = $("#deviceName").val().trim();
  const location = $("#deviceLocation").val().trim();
  if (!name) return alert("請輸入設備名稱");

  const needPwd = Date.now() > passwordValidatedUntil;
  if(needPwd){
    const pwd = $("#devicePassword").val();
    if(pwd !== "1234") return alert("密碼錯誤"); // 這裡可以換成你的密碼驗證
    passwordValidatedUntil = Date.now() + 60000;
  }

  if(!currentEdit){
    await apiPost({action:"create",name,location,createdAt:new Date().toISOString()});
  } else {
    await apiPost({
      action:"update",
      oldName: currentEdit.設備||currentEdit.name,
      name, location,
      createdAt:new Date().toISOString()
    });
  }
  $("#deviceModal").hide();
  loadDevices();
}

async function deleteDevice(){
  if(!confirm("確定要刪除嗎？")) return;
  const name = $("#deviceName").val().trim();
  await apiPost({action:"delete",name});
  $("#deviceModal").hide();
  loadDevices();
}

async function apiPost(payload){
  await fetch(`${PROXY_URL}?target=${SCRIPT_URL}`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
}

setInterval(renderTable,1000);
loadDevices();
</script>
</body>
</html>
