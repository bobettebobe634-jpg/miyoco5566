<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>公司設備管理</title>
  <style>
    body {font-family:"Microsoft JhengHei",sans-serif;background:#f7f9fc;margin:0;padding:20px;}
    h1{text-align:center;color:#333;}
    table{width:100%;border-collapse:collapse;background:white;margin-top:20px;}
    th,td{border:1px solid #ddd;padding:10px;text-align:center;}
    th{background:#f0f0f0;cursor:pointer;}
    tr.highlight {background:#e0e0e0;}
    .btn-area{text-align:center;margin-top:15px;}
    .btn-area button{padding:8px 15px;background:#4caf50;color:white;border:none;border-radius:5px;cursor:pointer;margin:0 8px;}
    #editModal,#locationModal,#loginModal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.3);}
    #editModal input,#locationModal input,#loginModal input{margin:5px 0;padding:6px;width:100%;}
    #editModal button,#locationModal button,#loginModal button{margin-top:10px;padding:6px 12px;}
    .location-item{display:flex;justify-content:space-between;align-items:center;background:#f5f5f5;padding:5px 10px;margin:3px 0;border-radius:4px;}
    .delete-loc{background:red;color:white;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;}
  </style>
</head>
<body>
  <h1>公司設備管理</h1>
  <div class="btn-area">
    <button id="addDeviceBtn">新增設備</button>
    <button id="manageLocBtn">常態位置</button>
  </div>

  <table id="deviceTable">
    <thead>
      <tr>
        <th onclick="sortTable('name')">設備 ⬍</th>
        <th onclick="sortTable('location')">目前位置 ⬍</th>
        <th onclick="sortTable('time')">累計時長 ⬍</th>
      </tr>
    </thead>
    <tbody id="deviceBody"></tbody>
  </table>

  <!-- 新增/修改設備彈窗 -->
  <div id="editModal">
    <h3>編輯設備</h3>
    <label>設備名稱：</label><br>
    <input type="text" id="editName"><br>
    <label>目前位置：</label><br>
    <input type="text" id="editLocation"><br>
    <button onclick="saveEdit()">儲存</button>
    <button onclick="deleteDevice()">刪除</button>
    <button onclick="closeModal()">取消</button>
  </div>

  <!-- 常態位置管理 -->
  <div id="locationModal">
    <h3>管理常態位置</h3>
    <div id="locationList"></div>
    <input type="text" id="newLoc" placeholder="新增位置名稱">
    <button onclick="addLocation()">新增</button>
    <button onclick="closeLocationModal()">關閉</button>
  </div>

  <!-- 密碼登入 -->
  <div id="loginModal">
    <h3>請輸入密碼</h3>
    <input type="password" id="passwordInput" placeholder="輸入密碼" onkeydown="if(event.key==='Enter'){checkPassword();}">
    <button onclick="checkPassword()">確認</button>
    <button onclick="closeLoginModal()">取消</button>
  </div>

  <script>
    const PASSWORD = "aaa";
    const PROXY_URL  = "https://my-proxy.miyoco5566.workers.dev";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFXnH7OvrIa70D6fz3c-ExZxXOtnz3bSC-EOoQA4Kko9qx2I8lhsIrKDILFscNQHmmAA/exec";

    let isLoggedIn = false;
    let lastLogin = 0;
    let devices = [];
    let normalLocations = JSON.parse(localStorage.getItem("normalLocations")) || [];
    if (!Array.isArray(normalLocations)) normalLocations = [];
    let sortState = {name:'asc',location:'asc',time:'asc'};
    let editingDevice = null;

    const addBtn = document.getElementById('addDeviceBtn');
    const locBtn = document.getElementById('manageLocBtn');
    const body = document.getElementById('deviceBody');
    const modal = document.getElementById('editModal');
    const editName = document.getElementById('editName');
    const editLocation = document.getElementById('editLocation');
    const locModal = document.getElementById('locationModal');
    const locList = document.getElementById('locationList');
    const newLocInput = document.getElementById('newLoc');
    const loginModal = document.getElementById('loginModal');
    const passwordInput = document.getElementById('passwordInput');

    async function apiPost(payload) {
      const url = `${PROXY_URL}?target=${encodeURIComponent(SCRIPT_URL)}`;
      const res = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function fetchDevices() {
      const url = `${PROXY_URL}?target=${encodeURIComponent(SCRIPT_URL)}`;
      const res = await fetch(url);
      devices = await res.json();
      render();
    }

    function formatDuration(ms){
      let sec = Math.floor(ms/1000);
      let days = Math.floor(sec / 86400);
      sec %= 86400;
      let hrs = Math.floor(sec / 3600);
      sec %= 3600;
      let mins = Math.floor(sec / 60);
      sec %= 60;
      return `${String(days).padStart(2,'0')}:${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function render(){
      body.innerHTML='';
      devices.forEach(d=>{
        const tr=document.createElement('tr');
        tr.onclick=()=>editDevice(d);
        let timeCell=normalLocations.includes((d.location||"").trim())?"N/A":formatDuration(Date.now()-d.createdAt);
        tr.innerHTML=`<td>${d.name}</td><td>${d.location||""}</td><td>${timeCell}</td>`;
        body.appendChild(tr);
      });
    }

    function sortTable(key){
      let direction = sortState[key]==='asc'?1:-1;
      if(key==='name'||key==='location'){
        devices.sort((a,b)=>(a[key]||"").localeCompare(b[key]||"")*direction);
      }else{
        devices.sort((a,b)=>{
          const ta=normalLocations.includes((a.location||"").trim())?Infinity:(Date.now()-a.createdAt);
          const tb=normalLocations.includes((b.location||"").trim())?Infinity:(Date.now()-b.createdAt);
          return (ta-tb)*direction;
        });
      }
      sortState[key]=sortState[key]==='asc'?'desc':'asc';
      render();
    }

    addBtn.onclick=()=>{checkLogin(openAddModal)};
    locBtn.onclick=()=>{checkLogin(openLocModal)};

    function checkLogin(next){
      if(isLoggedIn && Date.now()-lastLogin<60000){next();return;}
      window.afterLoginSuccess=next;
      loginModal.style.display="block";
      passwordInput.value='';
    }
    function checkPassword(){
      if(passwordInput.value===PASSWORD){
        isLoggedIn=true;lastLogin=Date.now();
        loginModal.style.display="none";
        if(window.afterLoginSuccess)window.afterLoginSuccess();
      }else alert("❌ 密碼錯誤");
    }
    function closeLoginModal(){loginModal.style.display="none";}

    function openAddModal(){editingDevice=null;editName.value='';editLocation.value='';modal.style.display="block";}
    function editDevice(d){checkLogin(()=>{editingDevice=d;editName.value=d.name;editLocation.value=d.location;modal.style.display="block";});}

    // ⚡️關鍵改動：判斷是否要重置 createdAt
    async function saveEdit(){
      const name=editName.value.trim();
      const loc=editLocation.value.trim();
      if(!name)return alert("設備名稱必填");

      if(editingDevice){
        // 判斷位置是否有變
        const locationChanged = editingDevice.location !== loc;
        await apiPost({
          action:'update',
          oldName:editingDevice.name,
          name,
          location:loc,
          resetTime: locationChanged // 告訴後端是否要重置時間
        });
      }else{
        await apiPost({action:'create',name,location:loc,createdAt:Date.now()});
      }
      modal.style.display="none";fetchDevices();
    }

    async function deleteDevice(){
      if(!editingDevice)return;
      if(!confirm("確定刪除？"))return;
      await apiPost({action:'delete',name:editingDevice.name});
      modal.style.display="none";fetchDevices();
    }
    function closeModal(){modal.style.display="none";}

    function openLocModal(){renderLocList();locModal.style.display="block";}
    function renderLocList(){
      locList.innerHTML='';
      normalLocations.forEach((loc,i)=>{
        const div=document.createElement('div');
        div.className='location-item';
        div.innerHTML=`<span>${loc}</span><button class="delete-loc" onclick="deleteLocation(${i})">刪除</button>`;
        locList.appendChild(div);
      });
    }
    function addLocation(){
      const val=newLocInput.value.trim();if(!val)return;
      if(!normalLocations.includes(val)){
        normalLocations.push(val);
        localStorage.setItem("normalLocations",JSON.stringify(normalLocations));
        renderLocList();render();
      }
      newLocInput.value='';
    }
    function deleteLocation(i){
      normalLocations.splice(i,1);
      localStorage.setItem("normalLocations",JSON.stringify(normalLocations));
      renderLocList();render();
    }
    function closeLocationModal(){locModal.style.display="none";}

    fetchDevices();
  </script>
</body>
</html>
