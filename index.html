<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>公司設備管理</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 900px; margin-top: 40px; }
    .device-row.inactive { color: #888; cursor: pointer; }
    .modal-header { background: #0d6efd; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">公司設備管理</h2>
    <div class="mb-3 text-center">
      <button class="btn btn-success" id="btnAdd">新增設備</button>
      <button class="btn btn-primary" id="btnDefaultLoc">常態位置</button>
    </div>
    <table class="table table-hover text-center">
      <thead class="table-dark">
        <tr>
          <th>設備</th>
          <th>目前位置</th>
          <th>累計時長</th>
        </tr>
      </thead>
      <tbody id="deviceTable"></tbody>
    </table>
  </div>

  <!-- 密碼 Modal -->
  <div class="modal fade" id="pwdModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">輸入管理密碼</h5></div>
        <div class="modal-body">
          <input type="password" id="inputPwd" class="form-control" placeholder="請輸入密碼" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" id="confirmPwd">確認</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯設備 Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">編輯設備</h5></div>
        <div class="modal-body">
          <input type="text" id="editName" class="form-control mb-2" placeholder="設備名稱" />
          <input type="text" id="editLoc" class="form-control" placeholder="目前位置" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="deleteDevice">刪除</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" id="saveEdit">儲存</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== 設定 ======
  const PROXY_URL = "https://my-proxy.miyoco5566.workers.dev"; // 改成你的 Cloudflare worker
  const TARGET_URL = "https://script.google.com/macros/s/AKfycbzFXnH7OvrIa70D6fz3c-ExZxXOtnz3bSC-EOoQA4Kko9qx2I8lhsIrKDILFscNQHmmAA/exec"; // 改成 Apps Script 部署後的 URL
  const PASSWORD = "1234"; // 你的管理密碼

  let devices = [];
  let selectedIndex = null;
  let lastAuthTime = 0;

  async function fetchDevices() {
    const resp = await fetch(`${PROXY_URL}?target=${encodeURIComponent(TARGET_URL)}`);
    devices = await resp.json();
    renderTable();
  }

  function renderTable() {
    const table = document.getElementById("deviceTable");
    table.innerHTML = "";
    devices.forEach((d, i) => {
      const tr = document.createElement("tr");
      tr.className = "device-row inactive";
      tr.innerHTML = `<td>${d.name}</td><td>${d.location}</td><td>${d.createdAt || ""}</td>`;
      tr.onclick = () => handleEditClick(i);
      table.appendChild(tr);
    });
  }

  // 點擊行 → 修改
  function handleEditClick(index) {
    selectedIndex = index;
    checkAuth().then(ok => {
      if (!ok) return;
      const d = devices[index];
      document.getElementById("editName").value = d.name;
      document.getElementById("editLoc").value = d.location;
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    });
  }

  async function checkAuth() {
    const now = Date.now();
    if (now - lastAuthTime < 60000) return true;
    const pwdModal = new bootstrap.Modal(document.getElementById('pwdModal'));
    pwdModal.show();

    return new Promise(resolve => {
      const confirmBtn = document.getElementById('confirmPwd');
      const input = document.getElementById('inputPwd');

      const handler = () => {
        if (input.value === PASSWORD) {
          lastAuthTime = Date.now();
          pwdModal.hide();
          resolve(true);
        } else {
          alert("密碼錯誤");
          resolve(false);
        }
        confirmBtn.removeEventListener("click", handler);
      };

      confirmBtn.addEventListener("click", handler);
      input.addEventListener("keypress", e => { if (e.key === "Enter") handler(); });
    });
  }

  // 儲存修改
  document.getElementById('saveEdit').onclick = async () => {
    const d = devices[selectedIndex];
    d.name = document.getElementById('editName').value;
    d.location = document.getElementById('editLoc').value;
    await saveDevice(d);
    await fetchDevices();
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
  };

  // 刪除設備
  document.getElementById('deleteDevice').onclick = async () => {
    // 這裡可以改成在試算表加一欄標示刪除，或直接呼叫特定刪除 API
    alert("刪除功能請在 Apps Script 端加上 doDelete 支援");
  };

  // 新增設備
  document.getElementById('btnAdd').onclick = async () => {
    const ok = await checkAuth();
    if (!ok) return;
    const name = prompt("輸入設備名稱");
    if (!name) return;
    const loc = prompt("輸入目前位置");
    if (!loc) return;
    await saveDevice({name, location: loc, createdAt: new Date().toLocaleString()});
    fetchDevices();
  };

  async function saveDevice(data) {
    await fetch(`${PROXY_URL}?target=${encodeURIComponent(TARGET_URL)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
  }

  fetchDevices();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
